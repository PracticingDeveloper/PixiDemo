<!doctype html>
<meta charset="utf-8">
<title>Displaying the canvas</title>
<body>
<script src="vendor/pixi.min.js"></script>
<script src="vendor/tink.js"></script>
<script src="vendor/underscore-min.js"></script>
<script src="vendor/bump.js"></script>

<script>

//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Texture = PIXI.Texture,
    Sprite = PIXI.Sprite,
    Graphics = PIXI.Graphics;
//Create a Pixi stage and renderer and add the 
//renderer.view to the DOM
var stage = new Container(),
    renderer = autoDetectRenderer(512, 512);
document.body.appendChild(renderer.view);

var drone, destination;

var widgets = [];

//load an image and run the `setup` function when it's done
loader
  .add("drone.png")
  .add("widget.png")
  .load(setup);

var t = new Tink(PIXI, renderer.view);
var b = new Bump(PIXI);

var pointer = t.makePointer();

pointer.tap = function() {
  destination.x = pointer.x;
  destination.y = pointer.y;
}

gameLoop();

function setup() {
  
    drone = new Sprite(resources["drone.png"].texture);  

    drone.x = 90;
    drone.y = 90;
    drone.circular = true;

    destination = {};
    destination.x = drone.x;
    destination.y = drone.y;
    stage.addChild(drone);

  _.times(1, function(n) {
    var widget = new Sprite(resources["widget.png"].texture);

    widget.x = 200 + Math.floor(Math.random()*200);
    widget.y = 50 + Math.floor(Math.random()*400);

    widget.scale.set(0.5, 0.5);
    widget.circular = true;
    widget.anchor.set(0.5,0.5)
    
    widgets.push(widget);

    stage.addChild(widget);
  });


  renderer.render(stage);
}


function gameLoop() {
  //Loop this function 60 times per second
  requestAnimationFrame(gameLoop);
  t.update();

  if (drone.x != destination.x || drone.y != destination.y) {
    drone.rotation += 0.02;
  }

  if (drone.x > destination.x) {
    drone.x -= 1;
  } else if (drone.x < destination.x) {
    drone.x += 1;
  }

  if (drone.y < destination.y) {
    drone.y += 1;
  } else if (drone.y > destination.y) {
    drone.y -= 1;
  }

  drone.anchor.set(0.5,0.5)

  var caught = _.find(widgets, function(e) { return b.hit(e, drone); });

  console.debug(caught);

  if (caught) {
    if (caught.x < drone.x) {
      caught.x += 1;
    } else if (caught.x > drone.x) {
      caught.x -= 1;
    }

    if (caught.y < drone.y) {
      caught.y += 1;
    } else if (caught.y > drone.y) {
      caught.y -= 1;
    }
  }

  renderer.render(stage);
}
</script>
</body>
