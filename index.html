<!doctype html>
<meta charset="utf-8">
<title>Displaying the canvas</title>
<body>
<script src="vendor/pixi.min.js"></script>
<script src="vendor/tink.js"></script>
<script src="vendor/underscore-min.js"></script>
<script src="vendor/bump.js"></script>
<script src="vendor/keyboard.js"></script>
<script>

//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Texture = PIXI.Texture,
    Sprite = PIXI.Sprite,
    Graphics = PIXI.Graphics;
//Create a Pixi stage and renderer and add the 
//renderer.view to the DOM
var stage = new Container(),
    renderer = autoDetectRenderer(1000,600);

renderer.backgroundColor = 0xFFFFFF;
document.body.appendChild(renderer.view);

var t = new Tink(PIXI, renderer.view);
var b = new Bump(PIXI);

var pointer = t.makePointer();

var space = keyboard(32);

var supplier, crate, order;

space.release = function() {
  //order.submit();
}

setup()
gameLoop();

function setup() {
  supplier = buildSupplier(200,200);
  crate    = buildCrate(510,140);

  order    = buildOrder(supplier, crate);

 _.times(3, function() {
    order.submit();
  });
}

function gameLoop() {
  id = requestAnimationFrame(gameLoop);
  t.update();
  
  renderer.render(stage);
}

function buildOrder(src, dest) {
  var o = { source: src, destination: dest };

  o.submit = function() {
    this.source.produce(this.fulfill)
  } 

  o.fulfill = function(widget) {
    o.destination.push(widget);
  }

  o.draw = function() {
    var line = new PIXI.Graphics();

    line.lineStyle(4, 0x333333, 1);
    line.moveTo(this.source.exit_point.x, this.source.exit_point.y);
    line.lineTo(this.destination.entrance_point.x, this.destination.entrance_point.y);
    stage.addChild(line);
  }

  o.draw();

  return o;
}

function buildCrate(x,y) {
  var crate = new PIXI.Graphics();

  crate.x = x;
  crate.y = y;

  crate.entrance_point = {x: x, y: y+90};

  crate.contents = [];

  t.makeInteractive(crate);

  crate.tap = function() {
    w = this.pop();

    if (w) {
      stage.removeChild(w)
      order.submit();
    }
  }

  //crate.entrance_point = {x: crate.x, y: crate.y + 50};
  //crate.exit_point     = {x: crate.x + 100, y: crate.y + 50};

  //crate.tap = function() { clicked.push(this); }

  crate.draw = function() {
    this.beginFill(0xffffff);
    this.lineStyle(5, 0x000000);
    this.drawPolygon([0,0,0,180,60,180,60,0]);
    this.endFill();
  }

  crate.push = function(widget) {
    this.contents.push(widget);

    widget.x = this.x + 30;
    widget.y = this.y + (4 - this.contents.length)*45;
  }

  crate.pop = function() {
    return this.contents.pop();
  }

  crate.isFull = function() {
    return this.contents.length == 3;
  }

  crate.draw();

  stage.addChild(crate);

  return crate;
}

function buildSupplier(x,y) {
  var supplier = new PIXI.Graphics();

  supplier.x = x;
  supplier.y = y;

  supplier.exit_point = {x: x + 45, y: y + 30};
  supplier.queue = [];

  supplier.draw = function() {
    this.beginFill(0xcc66cc);
    this.lineStyle(5, 0x000000);
    this.drawPolygon([0,60,45,30,0,0]);
    this.endFill();
  }

  supplier.start_job = function() {
    setTimeout(function() {
      var deliver = supplier.queue.pop();

      deliver(newWidget());
      if (supplier.queue.length > 0) {
        supplier.start_job();
      }
    }, 1000);
  }

  supplier.produce = function(deliver) {
    supplier.queue.push(deliver);

    if (supplier.queue.length == 1) {
      supplier.start_job();
    }
  }

  stage.addChild(supplier);
  supplier.draw();

  return supplier;
}


function newWidget() {
  var widget = new PIXI.Graphics();
  stage.addChild(widget);

  widget.beginFill(0xff00ff);
  widget.lineStyle(5, 0x000000);
  widget.drawCircle(0,0,15  );

  return widget;
};
</script>
</body>
