<!doctype html>
<meta charset="utf-8">
<title>Displaying the canvas</title>
<body>
<script src="vendor/pixi.min.js"></script>
<script src="vendor/tink.js"></script>
<script src="vendor/underscore-min.js"></script>
<script src="vendor/bump.js"></script>

<script>

//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Texture = PIXI.Texture,
    Sprite = PIXI.Sprite,
    Graphics = PIXI.Graphics;
//Create a Pixi stage and renderer and add the 
//renderer.view to the DOM
var stage = new Container(),
    renderer = autoDetectRenderer(1000,600);

renderer.backgroundColor = 0xFFFFFF;
document.body.appendChild(renderer.view);

var t = new Tink(PIXI, renderer.view);
var b = new Bump(PIXI);

var pointer = t.makePointer();

var drawables = [];

var clicked = [];

var space = keyboard(32);

var line = new PIXI.Graphics();
var connections = [];

space.release = function() {
  _.each(connections, function(e) {
    e.sink.pull(e.source);
  });
}

setup()
gameLoop();

function setup() {
  triangle = new PIXI.Graphics();

  triangle.draw = function() {
    this.beginFill(0xffffff);
    this.lineStyle(5, 0x000000);
    this.drawPolygon([0,0, 0, 100, 75,50]);
    this.endFill();

    this.x = 200;
    this.y = 200;

    triangle.exit_point = { x: triangle.x + 75, y: triangle.y + 50 };

  }

  triangle.tap = function() {
    clicked.push(this);
  };

  t.makeInteractive(triangle);


  drawables.push(triangle)
  _.times(1, function(i) {
    var diamond = new PIXI.Graphics();

    diamond.draw = function(i) {
      this.clear();
      this.beginFill(0x000000);
      //this.lineStyle(5, 0x000000);
      this.drawPolygon([0,50,50,0,100,50, 50,100]);
      this.endFill();
    }

    drawables.push(diamond)

    diamond.tap = function() {
      clicked.push(this);
    }

    t.makeInteractive(diamond);

    diamond.x = 600;
    diamond.y = 200;

    diamond.entrance_point = { x: diamond.x, y: diamond.y + 50 };

    diamond.pull = function(source) {
      if (source.widget) {
        this.widget = source.widget
        source.widget = null;
      }
    };

    stage.addChild(diamond);
  });

  _.each(drawables, function(e) { e.draw() })

  stage.addChild(triangle);
}


function gameLoop() {
  //Loop this function 60 times per second
  id = requestAnimationFrame(gameLoop);
  t.update();
  pointer.cursor = "auto";

  renderer.render(stage);

  if (clicked.length == 2) {
    var source = clicked[0];
    var sink   = clicked[1];

    line = new PIXI.Graphics();

    line.visible = true;
    line.lineStyle(4, 0x999999);
    line.moveTo(source.exit_point.x, source.exit_point.y);
    line.lineTo(sink.entrance_point.x, sink.entrance_point.y);

    stage.addChild(line);

    clicked = [];
    connections.push({source: source, sink: sink});
  }
}

function keyboard(keyCode) {
  var key = {};
  key.code = keyCode;
  key.isDown = false;
  key.isUp = true;
  key.press = undefined;
  key.release = undefined;
  //The `downHandler`
  key.downHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isUp && key.press) key.press();
      key.isDown = true;
      key.isUp = false;
      event.preventDefault();
    }
  };

  //The `upHandler`
  key.upHandler = function(event) {
    if (event.keyCode === key.code) {
      if (key.isDown && key.release) key.release();
      key.isDown = false;
      key.isUp = true;
      event.preventDefault();
    }
  };

  //Attach event listeners 
  window.addEventListener(
    "keydown", key.downHandler.bind(key), false
  );
  window.addEventListener(
    "keyup", key.upHandler.bind(key), false
  );
  return key;
}
</script>
</body>
