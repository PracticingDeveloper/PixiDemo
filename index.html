<!doctype html>
<meta charset="utf-8">
<title>Displaying the canvas</title>
<body>
<script src="vendor/pixi.min.js"></script>
<script src="vendor/tink.js"></script>
<script src="vendor/underscore-min.js"></script>
<script src="vendor/bump.js"></script>
<script src="vendor/keyboard.js"></script>
<script>

//Aliases
var Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.loader,
    resources = PIXI.loader.resources,
    TextureCache = PIXI.utils.TextureCache,
    Texture = PIXI.Texture,
    Sprite = PIXI.Sprite,
    Graphics = PIXI.Graphics;
//Create a Pixi stage and renderer and add the 
//renderer.view to the DOM
var stage = new Container(),
    renderer = autoDetectRenderer(1000,600);

renderer.backgroundColor = 0xFFFFFF;
document.body.appendChild(renderer.view);

var t = new Tink(PIXI, renderer.view);
var b = new Bump(PIXI);

var pointer = t.makePointer();

var stations = [];

var clicked = [];


var space = keyboard(32);

var line = new PIXI.Graphics();

space.release = function() {
  var sorted = _.sortBy(stations, function(e) { return -e.x; });

  _.each(sorted, function(e) { 
    if ((!e.widget || e.terminal) && e.source) {
      e.pull();
    }
  });

  _.each(stations, function(e) { e.moved = false; })
}

setup()
gameLoop();

function setup() {
  buildCrates();
  buildTerminal();   // FIXME: This shouldn't be order dependent, but currently needs to be called before generator.
  buildGenerator();


  _.each(stations, function(e) { e.draw() })  
}


function gameLoop() {
  //Loop this function 60 times per second
  id = requestAnimationFrame(gameLoop);
  t.update();
  pointer.cursor = "auto";

  renderer.render(stage);

  if (clicked.length == 2) {
    var source = clicked[0];
    var sink   = clicked[1];

    source.sink = sink;
    sink.source = source;

    line = new PIXI.Graphics();

    line.visible = true;
    line.lineStyle(4, 0x999999);
    line.moveTo(source.exit_point.x, source.exit_point.y);
    line.lineTo(sink.entrance_point.x, sink.entrance_point.y);

    stage.addChild(line);

    clicked = [];
  }
}

function buildCrates() {
  _.times(3, function(i) {
    var crate = new PIXI.Graphics();
    
    t.makeInteractive(crate);
    stations.push(crate);

    crate.x = 275 + i*200;
    crate.y = 200;

    crate.entrance_point = {x: crate.x, y: crate.y + 50};
    crate.exit_point     = {x: crate.x + 100, y: crate.y + 50};

    crate.tap = function() { clicked.push(this); }

    crate.draw = function() {
      this.beginFill(0xffffff);
      this.lineStyle(5, 0x000000);
      this.drawPolygon([0,0,0,100,100,100,100,0]);
      this.endFill();
    }

    crate.receive = function(widget) {
      widget.x = this.x + 50;
      widget.y = this.y + 50;

      this.widget   = widget;
    }

    crate.pull = function() {
      if(this.widget && !this.sink.moved) {
        this.sink.receive(this.widget)
        this.widget = null;
      } else if (this.source && !this.widget) {
        this.source.pull();
        this.moved = true;
      }
    };
    
    stage.addChild(crate);
  });
}

function buildTerminal() {  
  var terminal = new PIXI.Graphics();
  t.makeInteractive(terminal);
  
  terminal.x = 850;
  terminal.y = 200;

  terminal.entrance_point = {x: terminal.x, y: terminal.y + 50};
  terminal.exit_point     = {x: terminal.x + 75, y: terminal.y + 50};

  terminal.terminal = true;

  terminal.tap = function() { clicked.push(this); }

  terminal.draw = function() {
    this.beginFill(0x333333);
    this.lineStyle(5, 0x000000);
    this.drawPolygon([0,50,50,0,100,50,50,100]);
    this.endFill();
  }

  terminal.receive = function(widget) {
    widget.x = this.x + 50;
    widget.y = this.y + 50;

    this.widget   = widget;
  }

  terminal.pull = function() {
    if(this.widget) {
      stage.removeChild(this.widget);
      this.widget = null;
    } else if (this.source && !this.widget) {
      this.source.pull();
      this.moved = true;
    }
  };
  
  terminal.draw();
  stage.addChild(terminal);
  stations.push(terminal);
}


function buildGenerator() {  
  var generator = new PIXI.Graphics();
  t.makeInteractive(generator);
  
  
  generator.x = 100;
  generator.y = 200;

  generator.entrance_point = {x: generator.x, y: generator.y + 50};
  generator.exit_point     = {x: generator.x + 75, y: generator.y + 50};

  generator.tap = function() { clicked.push(this); }

  generator.draw = function() {
    this.beginFill(0xcccccc);
    this.lineStyle(5, 0x000000);
    this.drawPolygon([0,0,0,100,75,50]);
    this.endFill();
  }

  generator.receive = function(widget) {
    widget.x = this.x + 25;
    widget.y = this.y + 50;

    this.widget   = widget;
  }

  generator.pull = function() {
    if(this.widget && !this.sink.moved) {
      this.sink.receive(this.widget)
      this.widget = null;
    } else {
      this.receive(newWidget());
      this.moved   = true;
    }
  };
  
  generator.draw();
  stage.addChild(generator);
  stations.push(generator);

  generator.receive(newWidget());
}

function newWidget() {
  var widget = new PIXI.Graphics();
  stage.addChild(widget);

  widget.beginFill(0xff0000);
  widget.lineStyle(5, 0x000000);
  widget.drawCircle(0,0,15);

  return widget;
};
</script>
</body>
